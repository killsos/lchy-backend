<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>CSVæ–‡ä»¶ä¸Šä¼ </title>
    <style>
        body {
            background: #f5f6fa;
            font-family: 'Segoe UI', 'Arial', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .upload-card {
            background: #fff;
            padding: 32px 40px 24px 40px;
            border-radius: 12px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            min-width: 380px;
            text-align: center;
        }
        h2 {
            margin-bottom: 24px;
            color: #222f3e;
        }
        input[type="file"] {
            display: none;
        }
        .custom-file-label {
            display: inline-block;
            background: #4f8cff;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 10px 28px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s;
            margin-bottom: 20px;
        }
        .custom-file-label:hover {
            background: #2563eb;
        }
        .file-name {
            margin-left: 12px;
            font-size: 14px;
            color: #4f8cff;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            background: #f0f6ff;
            border-radius: 6px;
            padding: 4px 14px 4px 8px;
            box-shadow: 0 1px 4px rgba(79,140,255,0.07);
            transition: background 0.2s;
        }
        .file-name svg {
            margin-right: 6px;
        }
        button {
            background: #4f8cff;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 10px 28px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 15px;
        }
        button:hover {
            background: #2563eb;
        }
        button:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
        }
        #file-name-text {
            font-size: 12px;
        }
        .progress-container {
            margin: 20px 0;
            display: none;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: #4f8cff;
            width: 0%;
            transition: width 0.3s ease;
        }
        .progress-text {
            margin-top: 8px;
            font-size: 14px;
            color: #64748b;
        }
        .result-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
            text-align: left;
            white-space: pre-line;
            line-height: 1.5;
            max-width: 100%;
            word-wrap: break-word;
            font-size: 14px;
        }
        .result-success {
            background: #f0fdf4;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        .result-error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        .result-warning {
            background: #fffbeb;
            color: #d97706;
            border: 1px solid #fde68a;
        }
    </style>
</head>
<body>
    <div class="upload-card">
        <h2>ä¸Šä¼ CSVæ–‡ä»¶</h2>
        <div id="upload-form">
            <label class="custom-file-label">
                é€‰æ‹©CSVæ–‡ä»¶
                <input type="file" id="csv-file" accept=".csv" required onchange="showFileName(event)">
            </label>
            <span class="file-name" id="file-name">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" fill="none" style="vertical-align: middle; margin-right: 6px;"><path d="M4 2.5A1.5 1.5 0 0 0 2.5 4v12A1.5 1.5 0 0 0 4 17.5h12a1.5 1.5 0 0 0 1.5-1.5V7.914a1.5 1.5 0 0 0-.44-1.06l-4.914-4.914A1.5 1.5 0 0 0 12.086 2.5H4Z" stroke="#4f8cff" stroke-width="1.2" fill="#eaf1ff"/><path d="M13 2.5v4a1 1 0 0 0 1 1h4" stroke="#4f8cff" stroke-width="1.2"/></svg>
                <span id="file-name-text">è¯·å…ˆé€‰æ‹©è¦ä¸Šä¼ çš„CSVæ–‡ä»¶</span>
            </span><br>
            <button type="button" id="upload-btn" onclick="uploadFile()" disabled>ä¸Šä¼ æ–‡ä»¶</button>
        </div>
        
        <!-- è¿›åº¦æ¡ -->
        <div class="progress-container" id="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="progress-text" id="progress-text">ä¸Šä¼ ä¸­... 0%</div>
        </div>
        
        <!-- ç»“æœæ¶ˆæ¯ -->
        <div class="result-message" id="result-message"></div>
    </div>

    <!-- å¼•å…¥ axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    
    <script>
        let selectedFile = null;

        function showFileName(event) {
            const input = event.target;
            const uploadBtn = document.getElementById('upload-btn');
            
            if (input.files && input.files.length > 0) {
                selectedFile = input.files[0];
                const fileName = selectedFile.name;
                document.getElementById('file-name-text').textContent = fileName;
                
                // å®¢æˆ·ç«¯æ–‡ä»¶éªŒè¯
                const validationResult = validateFile(selectedFile);
                if (validationResult.valid) {
                    uploadBtn.disabled = false;
                    hideResult();
                } else {
                    uploadBtn.disabled = true;
                    selectedFile = null;
                    showResult(validationResult.message, validationResult.type || 'error');
                }
            } else {
                document.getElementById('file-name-text').textContent = 'è¯·å…ˆé€‰æ‹©è¦ä¸Šä¼ çš„CSVæ–‡ä»¶';
                uploadBtn.disabled = true;
                selectedFile = null;
            }
        }

        function validateFile(file) {
            const maxSize = 5 * 1024 * 1024; // 5MB
            const fileName = file.name.toLowerCase();
            
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!fileName.endsWith('.csv')) {
                return {
                    valid: false,
                    message: 'âŒ æ–‡ä»¶æ ¼å¼é”™è¯¯\n\nè¯·é€‰æ‹©CSVæ ¼å¼çš„æ–‡ä»¶ï¼ˆ.csvåç¼€ï¼‰',
                    type: 'error'
                };
            }
            
            // æ£€æŸ¥æ–‡ä»¶å¤§å°
            if (file.size > maxSize) {
                return {
                    valid: false,
                    message: `âŒ æ–‡ä»¶è¿‡å¤§\n\nå½“å‰æ–‡ä»¶å¤§å°ï¼š${(file.size / 1024 / 1024).toFixed(2)}MB\næœ€å¤§æ”¯æŒï¼š5MB\n\nğŸ’¡ å»ºè®®ï¼šè¯·ä½¿ç”¨è¾ƒå°çš„CSVæ–‡ä»¶æˆ–åˆ†æ‰¹ä¸Šä¼ `,
                    type: 'error'
                };
            }
            
            // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºç©º
            if (file.size === 0) {
                return {
                    valid: false,
                    message: 'âŒ æ–‡ä»¶ä¸ºç©º\n\nè¯·é€‰æ‹©åŒ…å«æ•°æ®çš„æœ‰æ•ˆCSVæ–‡ä»¶',
                    type: 'error'
                };
            }
            
            // æ£€æŸ¥æ–‡ä»¶å¤§å°æ˜¯å¦è¿‡å°ï¼ˆå¯èƒ½æ˜¯æ— æ•ˆæ–‡ä»¶ï¼‰
            if (file.size < 10) {
                return {
                    valid: false,
                    message: 'âš ï¸ æ–‡ä»¶å¯èƒ½æ— æ•ˆ\n\næ–‡ä»¶å¤§å°è¿‡å°ï¼Œè¯·ç¡®è®¤æ˜¯å¦ä¸ºæœ‰æ•ˆçš„CSVæ–‡ä»¶',
                    type: 'warning'
                };
            }
            
            return { valid: true };
        }

        function uploadFile() {
            if (!selectedFile) {
                showResult('è¯·å…ˆé€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶', 'error');
                return;
            }

            // æ–‡ä»¶å¤§å°æ£€æŸ¥ (5MB)
            const maxSize = 5 * 1024 * 1024;
            if (selectedFile.size > maxSize) {
                showResult('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡5MBï¼Œè¯·é€‰æ‹©è¾ƒå°çš„æ–‡ä»¶', 'error');
                return;
            }

            // æ–‡ä»¶å†…å®¹åˆæ­¥æ£€æŸ¥
            if (selectedFile.size === 0) {
                showResult('é€‰æ‹©çš„æ–‡ä»¶ä¸ºç©ºï¼Œè¯·é€‰æ‹©æœ‰æ•ˆçš„CSVæ–‡ä»¶', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('file', selectedFile);

            const uploadBtn = document.getElementById('upload-btn');
            const progressContainer = document.getElementById('progress-container');
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');

            // ç¦ç”¨ä¸Šä¼ æŒ‰é’®ï¼Œæ˜¾ç¤ºè¿›åº¦æ¡
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'ä¸Šä¼ ä¸­...';
            progressContainer.style.display = 'block';
            hideResult();

            // ä½¿ç”¨ axios ä¸Šä¼ æ–‡ä»¶
            axios.post('/upload/csv', formData, {
                headers: {
                    'Content-Type': 'multipart/form-data'
                },
                onUploadProgress: function(progressEvent) {
                    const percentCompleted = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                    progressFill.style.width = percentCompleted + '%';
                    progressText.textContent = `ä¸Šä¼ ä¸­... ${percentCompleted}%`;
                }
            })
            .then(function(response) {
                console.log('ä¸Šä¼ æˆåŠŸ:', response.data);
                
                if (response.data.success) {
                    const details = response.data.details;
                    let message = `âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼`;
                    
                    if (details) {
                        const csvRecords = details.csvRecords || 0;
                        const insertedRecords = details.insertedRecords || 0;
                        const validRecords = details.validRecords || csvRecords;
                        
                        message += `\nğŸ“Š æ•°æ®ç»Ÿè®¡ï¼š`;
                        message += `\nâ€¢ è§£æè®°å½•ï¼š${csvRecords} æ¡`;
                        if (validRecords !== csvRecords) {
                            message += `\nâ€¢ æœ‰æ•ˆè®°å½•ï¼š${validRecords} æ¡`;
                        }
                        message += `\nâ€¢ æˆåŠŸæ’å…¥ï¼š${insertedRecords} æ¡`;
                        
                        if (insertedRecords < validRecords) {
                            message += `\n\nâš ï¸ éƒ¨åˆ†æ•°æ®å¯èƒ½å› é‡å¤è€Œè¢«å¿½ç•¥`;
                        }
                    }
                    
                    showResult(message, 'success');
                } else {
                    showResult('âŒ ä¸Šä¼ å¤±è´¥ï¼š' + (response.data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
                
                resetUploadState();
            })
            .catch(function(error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                
                const friendlyError = getFriendlyErrorMessage(error);
                showResult(friendlyError, 'error');
                resetUploadState();
            });
        }

        function getFriendlyErrorMessage(error) {
            let message = 'âŒ ä¸Šä¼ å¤±è´¥ï¼š';
            
            if (error.response) {
                const status = error.response.status;
                const data = error.response.data;
                
                switch (status) {
                    case 400:
                        if (data && data.error) {
                            if (data.error.includes('æœªä¸Šä¼ æ–‡ä»¶')) {
                                message += 'æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶ï¼Œè¯·é‡æ–°é€‰æ‹©æ–‡ä»¶';
                            } else if (data.error.includes('CSVæ ¼å¼')) {
                                message += 'æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ç¡®ä¿ä¸Šä¼ çš„æ˜¯.csvæ ¼å¼æ–‡ä»¶';
                            } else if (data.error.includes('åªå…è®¸ä¸Šä¼ CSVæ–‡ä»¶')) {
                                message += 'åªæ”¯æŒCSVæ ¼å¼æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶ç±»å‹';
                            } else if (data.error.includes('æ–‡ä»¶å¤§å°')) {
                                message += 'æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº5MBçš„æ–‡ä»¶';
                            } else {
                                message += data.error;
                            }
                        } else {
                            message += 'è¯·æ±‚å‚æ•°é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼';
                        }
                        break;
                        
                    case 413:
                        message += 'æ–‡ä»¶å¤§å°è¶…å‡ºé™åˆ¶ï¼Œè¯·é€‰æ‹©å°äº5MBçš„CSVæ–‡ä»¶';
                        break;
                        
                    case 500:
                        if (data && data.error) {
                            if (data.error.includes('æ•°æ®åº“è¿æ¥å¤±è´¥')) {
                                message += 'æ•°æ®åº“è¿æ¥å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•æˆ–è”ç³»ç®¡ç†å‘˜';
                            } else if (data.error.includes('è§£æCSVå¤±è´¥')) {
                                message += 'CSVæ–‡ä»¶æ ¼å¼æœ‰è¯¯ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶å†…å®¹æ ¼å¼æ˜¯å¦æ­£ç¡®';
                            } else if (data.error.includes('æ•°æ®åº“æ’å…¥å¤±è´¥')) {
                                message += 'æ•°æ®ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ•°æ®æ ¼å¼æˆ–ç¨åé‡è¯•';
                            } else if (data.error.includes('æ²¡æœ‰æœ‰æ•ˆçš„æ•°æ®')) {
                                message += 'CSVæ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆæ•°æ®ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶å†…å®¹';
                            } else {
                                message += 'æœåŠ¡å™¨å¤„ç†å¼‚å¸¸ï¼š' + data.error;
                            }
                        } else {
                            message += 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
                        }
                        break;
                        
                    case 502:
                        message += 'æœåŠ¡å™¨ç½‘å…³é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
                        break;
                        
                    case 503:
                        message += 'æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•';
                        break;
                        
                    case 504:
                        message += 'æœåŠ¡å™¨å“åº”è¶…æ—¶ï¼Œæ–‡ä»¶å¯èƒ½è¿‡å¤§æˆ–ç½‘ç»œè¾ƒæ…¢';
                        break;
                        
                    default:
                        message += `æœåŠ¡å™¨é”™è¯¯ (${status})ï¼Œè¯·ç¨åé‡è¯•`;
                }
                
                // æ·»åŠ è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
                if (data && data.details && typeof data.details === 'string') {
                    message += `\n\nğŸ” è¯¦ç»†ä¿¡æ¯ï¼š${data.details}`;
                }
                
            } else if (error.request) {
                if (error.code === 'ECONNABORTED') {
                    message += 'ä¸Šä¼ è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–å°è¯•ä¸Šä¼ è¾ƒå°çš„æ–‡ä»¶';
                } else if (error.code === 'NETWORK_ERROR') {
                    message += 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•';
                } else {
                    message += 'ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•';
                }
            } else if (error.code === 'ERR_INVALID_RESPONSE') {
                message += 'æœåŠ¡å™¨å“åº”æ ¼å¼é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
            } else {
                message += error.message || 'æœªçŸ¥é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
            }
            
            // æ·»åŠ ç”¨æˆ·å‹å¥½çš„å»ºè®®
            message += '\n\nğŸ’¡ å»ºè®®ï¼š';
            if (error.response && error.response.status >= 500) {
                message += '\nâ€¢ è¯·ç¨åé‡è¯•\nâ€¢ å¦‚é—®é¢˜æŒç»­å­˜åœ¨ï¼Œè¯·è”ç³»æŠ€æœ¯æ”¯æŒ';
            } else if (error.response && error.response.status === 400) {
                message += '\nâ€¢ æ£€æŸ¥CSVæ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®\nâ€¢ ç¡®ä¿æ–‡ä»¶åŒ…å«å¿…éœ€çš„æ•°æ®åˆ—\nâ€¢ æ–‡ä»¶å¤§å°ä¸è¶…è¿‡5MB';
            } else {
                message += '\nâ€¢ æ£€æŸ¥ç½‘ç»œè¿æ¥\nâ€¢ å°è¯•åˆ·æ–°é¡µé¢åé‡æ–°ä¸Šä¼ ';
            }
            
            return message;
        }

        function resetUploadState() {
            const uploadBtn = document.getElementById('upload-btn');
            const progressContainer = document.getElementById('progress-container');
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');

            // é‡ç½®UIçŠ¶æ€
            setTimeout(() => {
                uploadBtn.disabled = selectedFile ? false : true;
                uploadBtn.textContent = 'ä¸Šä¼ æ–‡ä»¶';
                progressContainer.style.display = 'none';
                progressFill.style.width = '0%';
                progressText.textContent = 'ä¸Šä¼ ä¸­... 0%';
                
                // æˆåŠŸæ—¶æ¸…ç©ºæ–‡ä»¶é€‰æ‹©ï¼Œå¤±è´¥æ—¶ä¿ç•™æ–‡ä»¶ä¾¿äºé‡è¯•
                const resultElement = document.getElementById('result-message');
                const isSuccess = resultElement.classList.contains('result-success');
                
                if (isSuccess) {
                    document.getElementById('csv-file').value = '';
                    document.getElementById('file-name-text').textContent = 'è¯·å…ˆé€‰æ‹©è¦ä¸Šä¼ çš„CSVæ–‡ä»¶';
                    selectedFile = null;
                    uploadBtn.disabled = true;
                }
            }, 2000);
        }

        function showResult(message, type) {
            const resultElement = document.getElementById('result-message');
            resultElement.textContent = message;
            resultElement.className = 'result-message result-' + type;
            resultElement.style.display = 'block';
        }

        function hideResult() {
            const resultElement = document.getElementById('result-message');
            resultElement.style.display = 'none';
        }

        // é…ç½® axios é»˜è®¤è®¾ç½®
        axios.defaults.timeout = 30000; // 30ç§’è¶…æ—¶
        axios.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest';
    </script>
</body>
</html>